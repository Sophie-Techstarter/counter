name: Dockerize and Deploy to AWS ECS

on:
  push:
    branches:
      - main  # Der Workflow wird bei Pushes auf den "main"-Branch ausgelöst
  pull_request:
    branches:
      - main  # Der Workflow wird auch bei Pull Requests auf den "main"-Branch ausgelöst

jobs:
  build_and_push:
    runs-on: ubuntu-latest  # Nutzt den neuesten Ubuntu Runner

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4  # Checkout des Repositories

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3  # Setup Docker Buildx für Multi-Architektur-Bauten

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}  # Docker Hub Benutzername aus GitHub Secrets
          password: ${{ secrets.DOCKER_PASSWORD }}  # Docker Hub Passwort aus GitHub Secrets

      - name: Build Docker image
        run: |
          docker build -t ${{ secrets.DOCKER_USERNAME }}/mywebapp:$GITHUB_SHA .  # Baut das Docker-Image mit dem Commit Hash als Tag

      - name: Push Docker image
        run: |
          docker push ${{ secrets.DOCKER_USERNAME }}/mywebapp:$GITHUB_SHA  # Push das Image zu Docker Hub

  deploy_to_aws:
    runs-on: ubuntu-latest

    needs: build_and_push  # Dieser Job wird nach dem build_and_push Job ausgeführt

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up AWS CLI
        uses: aws-actions/configure-aws-credentials@v3
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}  # AWS Access Key aus GitHub Secrets
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}  # AWS Secret Key aus GitHub Secrets
          aws-region:  ${{ secrets.AWS_REGION }} 

      - name: Update ECS service
        run: |
          # Update die ECS Service mit dem neuen Docker-Image
          aws ecs update-service \
            --cluster DevCluster \
            --service counterApp \
            --force-new-deployment \
            --image ${DOCKER_USERNAME}/mywebapp:${GITHUB_SHA}
